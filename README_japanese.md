📘 English version → README.md

# Store Sales Time Series Forecasting

## プロジェクト概要（サマリー）

- **課題**：店舗 × 商品カテゴリごとの日次販売数を16日先まで予測  
- **手法**：LightGBM を中心とした時系列回帰モデル  
- **工夫点**：  
  - 時系列交差検証（CV）設計の改善  
  - リークを防ぐ特徴量設計  
  - CNN embedding の検証と定量的評価  
- **最終スコア（Public Leaderboard）**  
  - 単一モデル：0.42405  
  - **アンサンブル：0.41542**  
- **順位**：96 / 793（上位 約12%）

本プロジェクトでは、単なる精度向上ではなく、  
**再現性・妥当性・意思決定プロセス**を重視したモデリングを行った。

---

## 概要

本リポジトリは、Kaggle コンペティション  
**Store Sales – Time Series Forecasting** に対する解法をまとめたものである。

過去の販売実績および外部データ（原油価格・祝日情報など）を用いて、  
各 **店舗 × 商品カテゴリ** ごとの日次販売数を予測することを目的としている。

本プロジェクトでは以下を重視した。

- 時系列に配慮した交差検証
- 将来情報のリークを防ぐ特徴量設計
- 定量的検証に基づくモデル選択

Leaderboard 上のテクニックに依存しない、  
**実務を意識した設計**を心がけた。

---

## 結果

- **最終単一モデル（Public LB）**：0.42405  
- **アンサンブルモデル（Public LB）**：0.41542  
- **順位**：96 / 793（上位 約12%）

アンサンブルモデルは単一モデルを一貫して上回り、  
交差検証と Public Leaderboard の相関が取れていることを確認できた。

---

## 使用データ

Kaggle により提供された以下のデータセットを使用した。

- `train.csv` / `test.csv`：店舗 × 商品カテゴリごとの日次販売数  
- `stores.csv`：店舗情報（都市、州、店舗タイプ、クラスタ）  
- `oil.csv`：日次原油価格（欠損日は補完）  
- `holidays_events.csv`：祝日情報（国・地域・ローカル）

前処理の一貫性を保つため、train と test は結合して処理を行い、  
**販売数に依存する特徴量は必ず過去データのみを用いて算出**した。

---

## 検証戦略（最重要ポイント）

本プロジェクトにおいて、  
**精度が最も大きく向上した要因は交差検証（CV）設計の見直し**である。

### 初期の設計（改善前）

当初は以下の方法で特徴量を作成していた。

- 移動平均・平均系特徴量を  
  **全 fold の中で最も早い `train_end` より前の期間**のみで算出
- その特徴量を、すべての fold の validation 期間で共通使用

この方法はリークを防ぐ点では安全だが、

- 各 fold の学習期間で利用可能なデータを  
  **十分に活用できていない**

という問題があった。

---

### 改善後の設計（最終採用）

精度改善のため、以下のように設計を変更した。

- **データ分割（fold ループ）の内側で特徴量を生成**
- 各 fold ごとに  
  - `train_end` までの **全データ**を使用  
  - 平均系・移動平均系特徴量を再計算
- validation 期間には、その fold 専用の特徴量を使用

これにより、

- 各 fold で利用可能な過去データを最大限活用
- リークを防ぎつつ、情報量の多い特徴量を生成

することが可能となった。

---

### 効果

- 交差検証スコアが大幅に改善  
- CV と Public Leaderboard の整合性が向上  

この経験から、  
**時系列タスクではモデル選択以上に「検証設計」が重要である**  
ことを強く認識した。

---

## 時系列交差検証の設定

| Fold | 学習期間 | 検証期間 |
|---|---|---|
| 1 | 2013-01-01 → 2017-06-30 | 2017-07-01 → 2017-07-16 |
| 2 | 2013-01-01 → 2017-07-15 | 2017-07-17 → 2017-08-01 |
| 3 | 2013-01-01 → 2017-07-30 | 2017-07-31 → 2017-08-15 |

すべての fold において、  
販売実績を用いる特徴量は `train_end` 以前のデータのみを使用した。

---

## 特徴量設計

### Fold 非依存の特徴量

- 日付特徴量：年、月、日、曜日、週末フラグ  
- 原油価格特徴量：移動平均（30 / 90 / 180 日）  
- 祝日特徴量  
  - 国・地域・ローカル祝日フラグ  
  - 統合祝日フラグ  
  - 特別営業日（Workday）フラグ  

### Fold 依存（リーク防止）の特徴量

- 平均系特徴量（Target Encoding）  
  - store / family / store×family / type / cluster  
- 販売数の移動平均  
  - window：3 / 7 / 30 日  
  - shift により過去値のみ参照  

---

## モデル

### ベースモデル：LightGBM

- 目的関数：回帰（log 空間で RMSLE を評価）  
- 大規模特徴量に強い勾配ブースティングモデルを採用  
- ハイパーパラメータは Optuna により最適化  

### ハイパーパラメータチューニング

- Optuna + Median Pruner  
- 3-fold 時系列交差検証  
- 方針  
  1. CNN なしモデルでフルチューニング  
  2. 得られた best parameter を初期値として利用  
  3. CNN 使用時は軽量な探索のみ実施  

---

## SHAP 分析と特徴量削減（重要な知見）

SHAP により各特徴量の予測への寄与を分析した結果、

- 原油価格関連特徴量（`dcoilwtico`, `oil_mean_*`）は  
  **split importance は高いが SHAP 値は極めて小さい**
- 分岐には頻繁に利用される一方で、  
  **予測値を一貫して増減させる特徴量ではない**  
  ことが分かった

そこで、特徴量削減の検証を行った。

| モデル | CV mean RMSLE | CV std |
|---|---:|---:|
| 全特徴量 | 0.40420 | 0.02295 |
| 祝日系除外 | 0.40091 | 0.02256 |
| **原油系除外** | **0.39794** | **0.01680** |
| 原油＋祝日除外 | 0.40012 | 0.01759 |

原油系特徴量を除外したモデルでは、

- CV mean RMSLE が改善  
- fold 間の分散が大幅に低下  

し、**汎化性能と安定性の両方が向上**した。

この結果から、  
**情報量が小さくノイズとなり得る特徴量を除外することで、  
モデルの不安定性を低減できる**ことを確認した。

---

## CNN による時系列 Embedding（検証的実装）

rolling statistics では捉えきれない短期的なパターンを表現するため、  
1D CNN による時系列 embedding を検証した。

- 入力：過去 30 日間の特徴量  
  - promotion フラグ  
  - 祝日フラグ  
  - 曜日 / 日付  
  - 原油価格  
- 出力：固定次元の embedding ベクトル  
- CNN は学習せず、特徴抽出器として使用  

embedding は fold 単位でキャッシュし、  
Optuna 実行中の再計算を防いだ。

### 判断

- train スコアは改善  
- validation スコアの改善は一貫しなかった  

以上より、  
**再現性・簡潔性・推論コストを優先し、最終モデルでは CNN を不採用**とした。

---

## 最終学習と予測

- 2017-08-15 までの全データで最終学習  
- 2017-08-16 ～ 2017-08-31 を予測  
- 提出モデル  
  - 単一最終モデル  
  - CV 各 fold モデル＋最終モデルによるアンサンブル  

アンサンブルモデルが最良の Public LB スコアを達成した。

---

## まとめ・学び

- 時系列タスクでは **検証設計が性能を大きく左右する**  
- SHAP に基づく特徴量削減により、汎化性能と安定性が向上  
- 高コスト特徴量（CNN）は定量評価に基づいて採否を判断すべき  
- モデルの複雑化よりも、再現性と説明可能性を重視した  

---

## リポジトリ構成

- `store_sales_new.ipynb` / `.py`：前処理〜学習・予測  
- `models/`：fold ごとの LightGBM モデル  
- `submission.csv`：単一モデル提出  
- `submission_ensemble.csv`：アンサンブル提出  

---

## 補足

本プロジェクトでは、  
**検証結果に基づいてモデルや特徴量を取捨選択する意思決定プロセス**を  
重要な成果の一部として公開している。

---

## ライセンス

本プロジェクトは **MIT License** の下で公開されています。  
詳細は `LICENSE` ファイルをご覧ください。

